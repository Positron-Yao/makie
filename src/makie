#!/bin/bash

. ${HOME}/.daily/phrases

rm $HOME/.daily/*.daily 2> /dev/null

if [[ $# -eq 0 ]]; then
    # æ— å‘½ä»¤è¡Œå‚æ•°æ—¶:
    api_key="3762d7ab3be74be9bb530507251506"
    city="wuhan"
    diary="$DNDIARY/diary/"
    today=`date -Idate`
    hour=$(date +%H)
    if [[ -f "${HOME}/.daily/${today}.daily" ]]; then
        echo -e ${make_clean[$((RANDOM % ${#make_clean[@]}))]}
    else
        rm *.daily 2>/dev/null
        touch "${HOME}/.daily/${today}.daily"
        # echo "Today's daily file created successfully."
        # èŽ·å–å¤©æ°”
        # curl "http://api.weatherapi.com/v1/current.json?key=${api_key}&q=${city}&aqi=no&lang=zh"
        weather=`curl -s http://api.weatherapi.com/v1/current.json?key\=${api_key}\&q\=${city}\&aqi\=no\&lang\=zh | jq -r .current.condition.text`
        # èŽ·å–æ—¶é—´æ®µ
        echo $hour
        if (( hour >= 6 && hour < 12 )); then
            time_section="morning"
            case "${weather}" in
                *æ™´*) phrases=(${phrases0[@]}) ;;
                *äº‘*) phrases=(${phrases3[@]}) ;;
                *é˜´*) phrases=(${phrases6[@]}) ;;
                *é›¨*) phrases=(${phrases9[@]}) ;;
                *é›ª*) phrases=(${phrases12[@]}) ;;
                *) phrases=(${phrases_[@]}) ;;
            esac
        elif (( hour >= 12 && hour < 19 )); then
            time_section="noon"
            case "${weather}" in
                *æ™´*) phrases=(${phrases1[@]}) ;;
                *äº‘*) phrases=(${phrases4[@]}) ;;
                *é˜´*) phrases=(${phrases7[@]}) ;;
                *é›¨*) phrases=(${phrases10[@]}) ;;
                *é›ª*) phrases=(${phrases13[@]}) ;;
                *) phrases=(${phrases_[@]}) ;;
            esac
        elif (( hour >= 19 || hour < 6 )); then
            time_section="night"
            case "${weather}" in
                *æ™´*) phrases=(${phrases2[@]}) ;;
                *äº‘*) phrases=(${phrases5[@]}) ;;
                *é˜´*) phrases=(${phrases8[@]}) ;;
                *é›¨*) phrases=(${phrases11[@]}) ;;
                *é›ª*) phrases=(${phrases14[@]}) ;;
                *) phrases=(${phrases_[@]}) ;;
            esac
        fi
        # è§£æžè¾“å‡º
        printf "ä»Šå¤©æ˜¯ $(date '+%Yå¹´%mæœˆ%dæ—¥ æ˜ŸæœŸ')"
        case "$(date +%u)" in
            1) echo "ä¸€..." ;;
            2) echo "äºŒ" ;;
            3) echo "ä¸‰" ;;
            4) echo "å››" ;;
            5) echo "äº”" ;;
            6) echo "å…­!" ;;
            7) echo "æ—¥~" ;;
        esac
        printf "ä»Šæ—¥å¤©æ°”: ${weather}"
        case "${weather}" in
            *æ™´*) 
                if [[ $time_section = "night" ]]; then 
                    echo "ðŸŒ™ "
                else
                    echo "â˜€ï¸" 
                fi
                ;;
            *äº‘*) echo "â›…" ;;
            *é˜´*) echo "â˜ï¸" ;;
            *é›¨*) echo "ðŸŒ§" ;;
            *é›ª*) echo "ðŸŒ¨" ;;
            *) echo "" ;;
        esac

        idx=$((RANDOM % ${#phrases[@]}))
        echo "${phrases[idx]}"
        if (( RANDOM % 2 == 0 )); then
            # å‘¨æœ«é—®å€™
            if [[ $(date +%u) -gt 5 ]]; then
                echo "${weekend[$((RANDOM % ${#weekend[@]}))]}"
            elif [[ $(date +%u) -eq 1 ]]; then
                echo "${monday[$((RANDOM % ${#weekdays[@]}))]}"
            elif [[ $(date +%u) -eq 5 ]]; then
                echo "${friday[$((RANDOM % ${#weekdays[@]}))]}"
            else
                echo "${weekdays[$((RANDOM % ${#weekdays[@]}))]}"
            fi
        else
            # çº¯éšæœºé—®å€™
            echo "${roasts[$((RANDOM % ${#roasts[@]}))]}"
        fi
        # æ£€æŸ¥todo.mdçš„å†…å®¹
        todo_count=`cat $HOME/todo.md | grep "\[TODO\]" | wc -l`
        alert_count=`cat $HOME/todo.md | grep "\[ALRT\]" | wc -l`
        # wait_count=`cat $HOME/todo.md | grep "\[WAIT\]" | wc -l`
        # è¾“å‡ºtodoé—®å€™
        if [[ $todo_count -gt 0 ]]; then
            printf "${p_todo[$((RANDOM % ${#p_todo[@]}))]}\n" $todo_count
        fi
        if [[ $alert_count -gt 0 ]]; then
            printf "${p_alert[$((RANDOM % ${#p_alert[@]}))]}\n" $alert_count
            cat $HOME/todo.md | grep "\[ALRT\]" | glow
        fi
        # if [[ $wait_count -gt 0 ]]; then
        #     printf "${p_wait[$((RANDOM % ${#p_wait[@]}))]}\n" $wait_count
        # fi
    fi
    # æ£€æŸ¥æ˜¯å¦å†™äº†æ—¥è®°
    if [[ ! -f "${diary}$(date '+%Y-%m-%d').md" ]]; then
        echo -e ${dn[$((RANDOM % ${#dn[@]}))]}
    fi
else
    # æœ‰å‘½ä»¤è¡Œå‚æ•°çš„æƒ…å†µä¸‹
    case $1 in
        "clean") 
            # clean æ¨¡å¼
            ls_res=`ls $HOME/.daily/*.daily 2>/dev/null`
            if [ ! ${#ls_res} -eq 0 ]; then
                rm $HOME/.daily/*.daily 2>/dev/null
                echo "${cleaned[$((RANDOM % ${#cleaned[@]}))]}"
            else
                echo "${nothing_to_clean[$((RANDOM % ${#nothing_to_clean[@]}))]}"
            fi
            ;;
        *)
            echo "${nani[$((RANDOM % ${#nani[@]}))]}"
            ;;
    esac
fi

